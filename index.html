<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Home</title>
    <link rel="icon" type="image/x-icon" href="./assets/img/logo1.png" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="../css/style.css" />
    <link rel="manifest" href="/manifest.json" />
  </head>
  <body>
    <div class="app">
      <!-- Sidebar -->
      <div class="sidebar-mobile" id="sidebarMobile">
        <i class="fas fa-bars"></i>
      </div>
      <aside class="sidebar" role="navigation" aria-label="Main navigation">
        <div class="sidebar-inner">
          <h1 class="logo">GyanSetu</h1>

          <nav>
            <ul class="menu">
              <li class="menu-item active" data-page="home">
                <i class="fas fa-house"></i><span>Home</span>
              </li>
              <li class="menu-item" data-page="lessons">
                <i class="fas fa-book-open"></i><span>Lessons</span>
              </li>
              <li class="menu-item" data-page="games">
                <i class="fas fa-gamepad"></i><span>Games</span>
              </li>
              <li class="menu-item" data-page="progress">
                <i class="fas fa-chart-simple"></i><span>Progress</span>
              </li>
              <li class="menu-item" data-page="rewards">
                <i class="fas fa-award"></i><span>Rewards</span>
              </li>
              <li class="menu-item" data-page="settings">
                <i class="fas fa-gear"></i><span>Settings</span>
              </li>
            </ul>
          </nav>

          <div class="sidebar-bottom">
            <button class="login" id="loginBtn" style="background: none">
              <i class="fas fa-right-from-bracket"></i><span>Log Out</span>
            </button>
          </div>
        </div>
      </aside>

      <!-- Main content -->
      <main class="content">
        <!-- Top bar -->
        <!-- remove the old language markup inside topbar and add this once at top of <body> or keep it inside topbar but with class lang-fixed -->

        <!-- Pages -->
        <section id="home" class="page active">
          <h2 class="page-title">Home</h2>
          <h3 class="page-title" style="font-size: 30px">
            Welcome
            <span id="userName" class="gradient-text"></span> ðŸ‘‹
          </h3>
          <div class="cards">
            <article class="card card-cta card-orange">
              <div class="badge"><img src="./assets/img/1.png" /></div>
              <h3>Continue Learning</h3>
              <p>Resume your last lesson.</p>
              <button
                class="btn btn-orange"
                onclick="location.href='./templates/lessons.html'"
              >
                Get Started
              </button>
            </article>

            <article class="card card-cta card-purple">
              <div class="badge"><img src="./assets/img/2.png" /></div>
              <h3>Play Games</h3>
              <p>Engage in interactive games.</p>
              <button
                class="btn btn-purple"
                onclick="location.href='./templates/games.html'"
              >
                Get Started
              </button>
            </article>

            <article class="card card-cta card-orange">
              <div class="badge"><img src="./assets/img/3.png" /></div>
              <h3>Track Progress</h3>
              <p>Check your learning progress.</p>
              <button
                class="btn btn-orange"
                onclick="location.href='./templates/progress.html'"
              >
                Get Started
              </button>
            </article>

            <article class="card card-cta card-purple">
              <div class="badge"><img src="./assets/img/4.png" /></div>
              <h3>Earn Rewards</h3>
              <p>Collect points and badges.</p>
              <button
                class="btn btn-purple"
                onclick="location.href='./templates/rewards.html'"
              >
                Get Started
              </button>
            </article>
          </div>
        </section>
      </main>
    </div>
    <script src="./main.js"></script>
    <script src="../js/profile-widget.js"></script>
    <script src="../js/nav.js"></script>
    <script src="../js/script.js"></script>
    <script>
      // set/display user name into #userName using localStorage first, then IndexedDB (SettingsDB)
      async function initUserName() {
        const el = document.getElementById("userName");
        if (!el) return;

        // helper to try localStorage
        function nameFromLocalStorage() {
          try {
            const raw = localStorage.getItem("gyan_current_user");
            if (!raw) return null;
            const parsed = JSON.parse(raw);
            if (parsed && parsed.name) return String(parsed.name);
            return null;
          } catch (e) {
            console.warn(
              "failed reading gyan_current_user from localStorage",
              e
            );
            return null;
          }
        }

        // try localStorage first
        let name = nameFromLocalStorage();

        // if not found, try IndexedDB via SettingsDB if available
        if (
          !name &&
          window.SettingsDB &&
          typeof SettingsDB.openDB === "function"
        ) {
          try {
            await SettingsDB.openDB();

            // attempt to get email from localStorage login if there is one
            let loginRaw = null;
            try {
              loginRaw = JSON.parse(
                localStorage.getItem("gyan_current_user") || "null"
              );
            } catch (e) {
              loginRaw = null;
            }

            const emailCandidate =
              (loginRaw && loginRaw.email) ||
              (window.SettingsDB && window.SettingsDB.normalizeEmail
                ? SettingsDB.normalizeEmail("johndoe@email.com")
                : "johndoe@email.com");

            const rec = await SettingsDB.getSettings(
              window.SettingsDB && window.SettingsDB.normalizeEmail
                ? SettingsDB.normalizeEmail(emailCandidate)
                : emailCandidate
            );

            if (rec && rec.name) name = String(rec.name);
          } catch (e) {
            console.warn("error reading SettingsDB for user name", e);
          }
        }

        // fallback
        if (!name) name = "Learner";

        // set the text and add gradient class (you can remove class if you don't want gradient)
        el.textContent = name;
        el.classList.add("gradient-text");
      }

      // call on DOMContentLoaded
      window.addEventListener("DOMContentLoaded", () => {
        initUserName().catch((e) => console.error("initUserName failed", e));
      });
    </script>
  </body>
</html>
