<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>GyanSetu â€” Progress</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="../css/style.css" />
    <style>
      .panel {
        padding: 16px;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.02);
      }
      .progress-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 6px;
      }
      .bar {
        height: 12px;
        background: rgba(255, 255, 255, 0.06);
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 12px;
      }
      .fill {
        height: 100%;
        width: 0%;
        transition: width 300ms ease;
        background: linear-gradient(90deg, #7b61ff, #3fd1c9);
      }
      .badges-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .badge-item {
        padding: 8px 10px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.03);
        display: inline-flex;
        flex-direction: column;
        min-width: 120px;
      }
      .xp-header {
        display: flex;
        gap: 12px;
        align-items: center;
        margin-bottom: 12px;
      }
      .xp-number {
        font-weight: 700;
        font-size: 1.25rem;
      }
      #refreshProgressBtn {
        margin-left: auto;
        padding: 6px 10px;
        border-radius: 8px;
        border: 0;
        background: #2b1060;
        color: #fff;
        cursor: pointer;
      }
      .muted {
        color: rgba(255, 255, 255, 0.6);
      }
    </style>
    <script src="../js/settings-db.js" defer></script>
  </head>
  <body>
    <div class="app">
      <aside class="sidebar" role="navigation" aria-label="Main navigation">
        <div class="sidebar-inner">
          <h1 class="logo">GyanSetu</h1>
          <nav>
            <ul class="menu">
              <li class="menu-item" data-page="home">
                <i class="fas fa-house"></i><span>Home</span>
              </li>
              <li class="menu-item" data-page="lessons">
                <i class="fas fa-book-open"></i><span>Lessons</span>
              </li>
              <li class="menu-item" data-page="games">
                <i class="fas fa-gamepad"></i><span>Games</span>
              </li>
              <li class="menu-item" data-page="progress">
                <i class="fas fa-chart-simple"></i><span>Progress</span>
              </li>
              <li class="menu-item" data-page="rewards">
                <i class="fas fa-award"></i><span>Rewards</span>
              </li>
              <li class="menu-item" data-page="settings">
                <i class="fas fa-gear"></i><span>Settings</span>
              </li>
            </ul>
          </nav>
          <div class="sidebar-bottom">
            <button class="login" id="loginBtn" style="background: none">
              <i class="fas fa-right-from-bracket"></i><span>Log Out</span>
            </button>
          </div>
        </div>
      </aside>

      <main class="content">
        <section id="progress" class="page active">
          <h2 class="page-title">My Progress</h2>

          <div class="xp-header">
            <div>
              <div class="muted">Total XP</div>
              <div class="xp-number" id="xpNumber">0</div>
            </div>
            <button id="refreshProgressBtn">Refresh</button>
          </div>

          <div class="grid-2">
            <div class="panel">
              <h3>Subject Progress</h3>
              <div class="progress-row">
                <span>Mathematics</span>
                <span class="muted" id="mathPercentLabel">0%</span>
              </div>
              <div class="bar">
                <div id="mathFill" class="fill" style="width: 0%"></div>
              </div>

              <div class="progress-row" style="margin-top: 14px">
                <span>Science</span>
                <span class="muted" id="sciencePercentLabel">0%</span>
              </div>
              <div class="bar">
                <div id="scienceFill" class="fill" style="width: 0%"></div>
              </div>

              <div id="otherSubjects"></div>
            </div>

            <div class="panel">
              <h3>Badges & Streaks</h3>
              <ul class="badges-list" id="badgesList"></ul>
              <div style="margin-top: 12px">
                <h4>Streak</h4>
                <div id="streakInfo" class="muted">â€”</div>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>

    <script src="../js/settings-db.js"></script>
    <script src="../js/db.js"></script>
    <script>
      (function () {
        const DEFAULT_EMAIL = "johndoe@email.com";

        const xpNumberEl = document.getElementById("xpNumber");
        const mathFill = document.getElementById("mathFill");
        const scienceFill = document.getElementById("scienceFill");
        const mathLabel = document.getElementById("mathPercentLabel");
        const scienceLabel = document.getElementById("sciencePercentLabel");
        const otherSubjectsRoot = document.getElementById("otherSubjects");
        const badgesListEl = document.getElementById("badgesList");
        const streakInfoEl = document.getElementById("streakInfo");
        const refreshBtn = document.getElementById("refreshProgressBtn");

        let currentEmail = null;
        let settings = null;

        async function getCurrentEmail() {
          if (window.currentUser && window.currentUser.email)
            return window.currentUser.email;
          try {
            const raw = localStorage.getItem("gyan_current_user");
            if (raw) {
              const parsed = JSON.parse(raw);
              if (parsed && parsed.email) return parsed.email;
            }
          } catch {}
          return DEFAULT_EMAIL;
        }

        function applyPercentToFill(el, labelEl, val) {
          const pct = Math.max(0, Math.min(100, Number(val) || 0));
          el.style.width = pct + "%";
          labelEl.textContent = pct + "%";
        }

        function renderBadges(badges) {
          badgesListEl.innerHTML = "";
          (badges || []).forEach((b) => {
            const li = document.createElement("li");
            li.className = "badge-item";
            li.innerHTML = `<strong>${String(
              b
            )}</strong><div class="muted" style="font-size:0.85rem">Badge</div>`;
            badgesListEl.appendChild(li);
          });
        }

        function canonicalSubject(raw) {
          if (!raw) return "Other";
          const s = String(raw).trim().toLowerCase();
          if (!s) return "Other";
          const map = {
            math: "Mathematics",
            maths: "Mathematics",
            mathematics: "Mathematics",
            science: "Science",
            sci: "Science",
          };
          if (map[s]) return map[s];
          if (s.startsWith("math")) return "Mathematics";
          if (s.startsWith("sci")) return "Science";
          return s.charAt(0).toUpperCase() + s.slice(1);
        }

        async function loadAndRender() {
          try {
            if (SettingsDB.openDB) await SettingsDB.openDB();
            if (LessonDB.openDB) await LessonDB.openDB();
          } catch (e) {
            console.warn("DB open failed", e);
          }

          currentEmail = await getCurrentEmail();

          // Load settings (XP, badges, grade)
          try {
            const s = await SettingsDB.getSettings(currentEmail);
            settings = s || {
              email: currentEmail,
              xp: 0,
              badges: [],
              progress: {},
              streak: null,
              grade: "8",
            };
            if (!s) await SettingsDB.saveSettings(settings);

            xpNumberEl.textContent = (Number(settings.xp) || 0).toLocaleString();
            renderBadges(settings.badges || []);
            streakInfoEl.textContent =
              (settings.streak && String(settings.streak)) || "No active streak";
          } catch (e) {
            console.error("Settings load failed", e);
          }

          // Compute subject progress
          try {
            const res = await fetch("../data/lessons.json", { cache: "no-store" });
            if (!res.ok) throw new Error("Could not fetch lessons.json");
            let lessons = await res.json();

            // ðŸ”¥ only keep lessons matching user grade
            if (settings && settings.grade) {
              lessons = lessons.filter(
                (l) => String(l.grade) === String(settings.grade)
              );
            }

            const bySubject = {};
            for (const lesson of lessons) {
              const subject = canonicalSubject(lesson.subject);
              if (!bySubject[subject]) bySubject[subject] = [];
              bySubject[subject].push(lesson);
            }

            const subjectAverages = {};
            for (const [subject, list] of Object.entries(bySubject)) {
              let sum = 0;
              const total = list.length; // âœ… denominator is total lessons
              for (const l of list) {
                try {
                  const progress = await LessonDB.getProgress(currentEmail, l.id);
                  if (progress && typeof progress.percent === "number") {
                    sum += Number(progress.percent);
                  } else {
                    sum += 0; // unopened lesson
                  }
                } catch (e) {
                  console.warn("Lesson progress read failed", l.id, e);
                  sum += 0;
                }
              }
              const avg = total ? Math.round(sum / total) : 0;
              subjectAverages[subject] = { avg, lessons: total };
            }

            applyPercentToFill(
              mathFill,
              mathLabel,
              subjectAverages["Mathematics"]?.avg || 0
            );
            applyPercentToFill(
              scienceFill,
              scienceLabel,
              subjectAverages["Science"]?.avg || 0
            );

            otherSubjectsRoot.innerHTML = "";
            Object.entries(subjectAverages)
              .filter(([k]) => k !== "Mathematics" && k !== "Science")
              .sort((a, b) => a[0].localeCompare(b[0]))
              .forEach(([subject, info]) => {
                const div = document.createElement("div");
                div.style.marginTop = "12px";
                div.innerHTML = `
                  <div class="progress-row"><span>${subject}</span>
                  <span class="muted">${info.avg}%</span></div>
                  <div class="bar"><div class="fill" style="width:${info.avg}%"></div></div>
                `;
                otherSubjectsRoot.appendChild(div);
              });
          } catch (e) {
            console.error("Progress load failed", e);
          }
        }

        refreshBtn.addEventListener("click", loadAndRender);
        window.addEventListener("DOMContentLoaded", loadAndRender);
      })();
    </script>

    <script src="../main.js"></script>
    <script src="../js/profile-widget.js"></script>
    <script src="../js/nav.js"></script>
    <script src="../js/script.js"></script>
  </body>
</html>
