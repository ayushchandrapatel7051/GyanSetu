<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>GyanSetu â€” Settings</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="../css/style.css" />

    <style>
      /* minimal helpers (rest is in style.css) */
      .settings-grid {
        display: grid;
        grid-template-columns: 1fr 320px;
        gap: 18px;
        align-items: start;
      }
      .setting-card {
        background: var(--card);
        padding: 18px;
        border-radius: 12px;
        box-shadow: var(--shadow);
      }
      .profile-card {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }
      .profile-info {
        display: flex;
        gap: 12px;
        align-items: center;
      }
      .avatar {
        width: 64px;
        height: 64px;
        object-fit: cover;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.03);
      }
      .muted {
        color: var(--muted);
      }
      .btn {
        padding: 8px 12px;
        border-radius: 8px;
        cursor: pointer;
      }
      .small {
        width: 120px;
      }
      .badges-list {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 8px;
      }
      .badge-chip {
        padding: 6px 8px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.03);
      }
      input.input,
      select.input,
      textarea.input {
        width: 100%;
        padding: 8px;
        border-radius: 8px;
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.04);
        color: var(--text);
      }
      .modal-avatar {
        width: 160px;
        height: 160px;
        border-radius: 12px;
        object-fit: cover;
        background: rgba(255, 255, 255, 0.02);
      }
    </style>
  </head>

  <body>
    <div class="app">
      <aside class="sidebar" role="navigation" aria-label="Main navigation">
        <div class="sidebar-inner">
          <h1 class="logo">GyanSetu</h1>
          <nav>
            <ul class="menu">
              <li class="menu-item" data-page="home">
                <i class="fas fa-house"></i><span>Home</span>
              </li>
              <li class="menu-item" data-page="lessons">
                <i class="fas fa-book-open"></i><span>Lessons</span>
              </li>
              <li class="menu-item" data-page="games">
                <i class="fas fa-gamepad"></i><span>Games</span>
              </li>
              <li class="menu-item" data-page="progress">
                <i class="fas fa-chart-simple"></i><span>Progress</span>
              </li>
              <li class="menu-item" data-page="rewards">
                <i class="fas fa-award"></i><span>Rewards</span>
              </li>
              <li class="menu-item active" data-page="settings">
                <i class="fas fa-gear"></i><span>Settings</span>
              </li>
            </ul>
          </nav>
          <div class="sidebar-bottom">
            <button class="login" id="loginBtn" style="background: none">
              <i class="fas fa-right-from-bracket"></i><span>Log Out</span>
            </button>
          </div>
        </div>
      </aside>

      <main class="content">
        <div class="lang-fixed">
          <i class="fas fa-globe"></i>
          <label for="language" class="lang-label">Language:</label>
          <select id="language" class="lang-select input">
            <option value="en">English</option>
            <option value="hi">Hindi</option>
            <option value="or">Odia</option>
          </select>
        </div>

        <section id="settings" class="page active">
          <h2 class="page-title">Settings</h2>

          <div class="settings-grid">
            <!-- Profile, language, grade -->
            <div>
              <div class="setting-card profile-card">
                <div class="profile-card-content" style="display:flex;gap:12px;align-items:center">
                  <div class="profile-info">
                    <img id="profileAvatar" src="../assets/img/1.png" alt="Profile" class="avatar"/>
                    <div class="profile-text">
                      <h3 id="profileName">John Doe</h3>
                      <p class="muted" id="profileEmail">johndoe@email.com</p>
                    </div>
                  </div>
                </div>
                <div>
                  <button class="edit-profile-btn" id="openEditBtn">Edit Profile</button>
                </div>
              </div>

              <div class="setting-card" style="margin-top:16px">
                <h4>Language</h4>
                <div class="dropdown-row" style="margin-top:12px">
                  <select id="cardLanguage" class="input">
                    <option value="en">English</option>
                    <option value="hi">Hindi</option>
                    <option value="or">Odia</option>
                  </select>
                </div>
              </div>

              <div class="setting-card" style="margin-top:12px">
                <h4>Grade</h4>
                <div class="dropdown-row" style="margin-top:12px">
                  <select id="cardGrade" class="input small">
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>

    <!-- EDIT PROFILE MODAL -->
    <div id="editModal" class="modal" role="dialog" aria-hidden="true">
      <div class="modal-card" role="document">
        <div style="display:flex;flex-direction:column;gap:12px;align-items:center">
          <img id="modalAvatar" src="../assets/img/avatar.jpg" alt="avatar preview" class="modal-avatar"/>
          <input type="file" id="modalAvatarFile" accept="image/*" />
          <button class="btn" id="modalUploadAvatar">Preview Image</button>
        </div>
        <div>
          <h3>Edit profile</h3>
          <label class="muted">Name</label>
          <input id="modalName" class="input"/>
          <label class="muted" style="margin-top:8px">Email</label>
          <input id="modalEmail" class="input"/>
          <label class="muted" style="margin-top:8px">Profile text</label>
          <textarea id="modalProfile" rows="3" class="input"></textarea>
          <div style="display:flex;gap:8px;margin-top:8px">
            <div style="flex:1">
              <label class="muted">Grade</label>
              <select id="modalGrade" class="input small">
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
              </select>
            </div>
            <div style="flex:1">
              <label class="muted">Language</label>
              <select id="modalLanguage" class="input">
                <option value="en">English</option>
                <option value="hi">Hindi</option>
                <option value="or">Odia</option>
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn" id="modalCancelBtn">Cancel</button>
            <button class="btn edit-profile-btn" id="modalSaveBtn">Save</button>
            <button class="btn danger" id="modalDeleteBtn">Delete Profile</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings DB wrapper -->
    <script src="../js/settings-db.js"></script>

    <!-- Integration script -->
    <script>
  (function(){
    const profileAvatar = document.getElementById("profileAvatar");
    const profileName = document.getElementById("profileName");
    const profileEmail = document.getElementById("profileEmail");
    const cardLanguage = document.getElementById("cardLanguage");
    const cardGrade = document.getElementById("cardGrade");
    const openEditBtn = document.getElementById("openEditBtn");
    const editModal = document.getElementById("editModal");
    const modalName = document.getElementById("modalName");
    const modalEmail = document.getElementById("modalEmail");
    const modalProfile = document.getElementById("modalProfile");
    const modalGrade = document.getElementById("modalGrade");
    const modalLanguage = document.getElementById("modalLanguage");
    const modalAvatar = document.getElementById("modalAvatar");
    const modalCancelBtn = document.getElementById("modalCancelBtn");
    const modalSaveBtn = document.getElementById("modalSaveBtn");
    const modalDeleteBtn = document.getElementById("modalDeleteBtn");

    const DEFAULT_EMAIL = "johndoe@email.com";
    const DEFAULT_SETTINGS = {
      email: DEFAULT_EMAIL,
      name: "John Doe",
      language: "en",
      grade: "8",
      profile: "Learner",
      avatar: "../assets/img/avatar.jpg",
      badges: [],
      xp: 0,
      updatedAt: Date.now()
    };

    let currentSettings = null;

    function normalizeLanguage(lang){
      if(!lang) return "en";
      const l = String(lang).toLowerCase();
      if(l==="en"||l==="english") return "en";
      if(l==="hi"||l==="hindi") return "hi";
      if(l==="or"||l==="odia"||l==="oriya") return "or";
      return "en";
    }

    // merge function: choose newest for each whole object (DB vs login)
    function pickNewest(dbRec, loginRec) {
      if(!dbRec && !loginRec) return null;
      if(!dbRec) return loginRec;
      if(!loginRec) return dbRec;
      const dbTime = dbRec.updatedAt ? Number(dbRec.updatedAt) : 0;
      const loginTime = loginRec.updatedAt ? Number(loginRec.updatedAt) : 0;
      return dbTime >= loginTime ? dbRec : loginRec;
    }

    // read login session (localStorage)
    function readLoginSession() {
      const raw = localStorage.getItem("gyan_current_user");
      if(!raw) return null;
      try {
        const parsed = JSON.parse(raw);
        if(parsed && parsed.email && window.SettingsDB && window.SettingsDB.normalizeEmail) {
          parsed.email = window.SettingsDB.normalizeEmail(parsed.email);
        }
        // ensure numeric updatedAt
        if(parsed && parsed.updatedAt) parsed.updatedAt = Number(parsed.updatedAt) || Date.now();
        return parsed;
      } catch(e) {
        console.warn("failed to parse gyan_current_user", e);
        return null;
      }
    }

    // write session
    function writeLoginSession(obj){
      try {
        localStorage.setItem("gyan_current_user", JSON.stringify(obj));
      } catch(e){
        console.warn("failed to write gyan_current_user", e);
      }
    }

    async function loadAndSync(emailFromLogin) {
      // ensure DB ready
      await SettingsDB.openDB();
      const loginRec = readLoginSession() || {};
      const emailCandidate = emailFromLogin || loginRec.email || DEFAULT_SETTINGS.email;
      const normalizedEmail = SettingsDB.normalizeEmail(emailCandidate || DEFAULT_SETTINGS.email);

      // fetch DB record
      const dbRec = await SettingsDB.getSettings(normalizedEmail);

      // if no dbRec but loginRec has data, save loginRec into DB (initial save)
      if(!dbRec && loginRec && loginRec.email) {
        // fill with defaults
        const toSave = Object.assign({}, DEFAULT_SETTINGS, loginRec, { email: normalizedEmail, updatedAt: loginRec.updatedAt || Date.now() });
        await SettingsDB.saveSettings(toSave).catch(err => console.warn("initial save failed", err));
        writeLoginSession(toSave);
        currentSettings = toSave;
      } else {
        // pick latest between db and login (based on updatedAt)
        const dbProcessed = dbRec ? Object.assign({}, DEFAULT_SETTINGS, dbRec) : null;
        const loginProcessed = loginRec ? Object.assign({}, DEFAULT_SETTINGS, loginRec) : null;
        const winner = pickNewest(dbProcessed, loginProcessed) || DEFAULT_SETTINGS;
        // ensure normalized email and language
        winner.email = SettingsDB.normalizeEmail(winner.email || DEFAULT_SETTINGS.email);
        winner.language = normalizeLanguage(winner.language);
        currentSettings = winner;
        // make DB and localStorage consistent: if localStorage older than DB, update it; if DB older and login newer, save to DB
        const dbTime = dbProcessed && dbProcessed.updatedAt ? Number(dbProcessed.updatedAt) : 0;
        const winTime = winner.updatedAt ? Number(winner.updatedAt) : Date.now();
        if(!dbRec || winTime > dbTime) {
          try { await SettingsDB.saveSettings(winner); } catch(e){ console.warn("sync save to DB failed", e); }
        }
        writeLoginSession(winner);
      }

      applyToUI(currentSettings);
      console.debug("Loaded settings:", currentSettings);
    }

    function applyToUI(s) {
      profileName.textContent = s.name || "Unknown";
      profileEmail.textContent = s.email || "";
      profileAvatar.src = s.avatar || "../assets/img/avatar.jpg";
      cardLanguage.value = s.language || "en";
      cardGrade.value = s.grade || "8";
      const topLang = document.getElementById("language");
      if(topLang) topLang.value = s.language || "en";
    }

    // Watch for other scripts changing gyan_current_user in localStorage (helps debug overwrite sources)
    window.addEventListener("storage", (ev) => {
      if(ev.key === "gyan_current_user") {
        console.warn("localStorage gyan_current_user changed (storage event). Old:", ev.oldValue, "New:", ev.newValue);
        // optionally reload / re-sync if you want immediate response
        try {
          const parsed = JSON.parse(ev.newValue || "{}");
          // quick sanity: if new value is older than our current settings, log suspicious
          const newTime = parsed && parsed.updatedAt ? Number(parsed.updatedAt) : 0;
          const curTime = currentSettings && currentSettings.updatedAt ? Number(currentSettings.updatedAt) : 0;
          if(newTime < curTime) {
            console.warn("A stale localStorage value replaced a newer profile. That is likely the cause of reverts.");
          } else {
            // otherwise, apply it
            applyToUI(parsed);
            currentSettings = parsed;
          }
        } catch(e) { console.warn("failed to parse new storage value", e); }
      }
    });

    // boot
    window.addEventListener("DOMContentLoaded", async () => {
      await SettingsDB.openDB();
      // load login session email if any
      const login = readLoginSession();
      const email = login && login.email ? login.email : DEFAULT_SETTINGS.email;
      await loadAndSync(email);
    });

    // open edit modal
    openEditBtn.addEventListener("click", ()=>{
      if(!currentSettings) return;
      modalName.value = currentSettings.name || "";
      modalEmail.value = currentSettings.email || "";
      modalProfile.value = currentSettings.profile || "";
      modalGrade.value = currentSettings.grade || "8";
      modalLanguage.value = currentSettings.language || "en";
      modalAvatar.src = currentSettings.avatar || "../assets/img/avatar.jpg";
      editModal.classList.add("show");
    });

    modalCancelBtn.addEventListener("click", ()=> editModal.classList.remove("show"));

    modalSaveBtn.addEventListener("click", async()=>{
      const newEmailRaw = (modalEmail.value||"").trim();
      if(!newEmailRaw) return alert("Email is required");

      const normalizedEmail = SettingsDB.normalizeEmail(newEmailRaw);

      const updated = Object.assign({}, currentSettings, {
        email: normalizedEmail,
        name: modalName.value||"Unknown",
        profile: modalProfile.value||"",
        grade: modalGrade.value||"8",
        language: normalizeLanguage(modalLanguage.value),
        avatar: modalAvatar.src || "../assets/img/avatar.jpg",
        updatedAt: Date.now()
      });

      try {
        await SettingsDB.saveSettings(updated);
        writeLoginSession(updated);
        await loadAndSync(normalizedEmail);
        editModal.classList.remove("show");
        alert("Profile saved");
      } catch(e){
        console.error("save error", e);
        alert("Failed to save profile. See console for details.");
      }
    });

    modalDeleteBtn.addEventListener("click", async()=>{
      if(!currentSettings||!currentSettings.email) return;
      const normalized = SettingsDB.normalizeEmail(currentSettings.email);
      try {
        await SettingsDB.deleteSettings(normalized);
        localStorage.removeItem("gyan_current_user");
        await loadAndSync(DEFAULT_SETTINGS.email);
        editModal.classList.remove("show");
        alert("Profile deleted");
      } catch(e){
        console.error("delete error", e);
        alert("Failed to delete profile. See console.");
      }
    });

  })();
</script>


    <script src="../main.js"></script>
    <script src="../js/nav.js"></script>
    <script src="../js/script.js"></script>
  </body>
</html>
