<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>GyanSetu â€” Settings</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="../css/style.css" />

    <style>
      /* minimal helpers (rest is in style.css) */
      .settings-grid {
        display: grid;
        grid-template-columns: 1fr 320px;
        gap: 18px;
        align-items: start;
      }
      .setting-card {
        background: var(--card);
        padding: 18px;
        border-radius: 12px;
        box-shadow: var(--shadow);
      }
      .profile-card {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }
      .profile-info {
        display: flex;
        gap: 12px;
        align-items: center;
      }
      .avatar {
        width: 64px;
        height: 64px;
        object-fit: cover;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.03);
      }
      .muted {
        color: var(--muted);
      }
      .btn {
        padding: 8px 12px;
        border-radius: 8px;
        cursor: pointer;
      }
      .small {
        width: 120px;
      }
      .badges-list {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 8px;
      }
      .badge-chip {
        padding: 6px 8px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.03);
      }
      input.input,
      select.input,
      textarea.input {
        width: 100%;
        padding: 8px;
        border-radius: 8px;
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.04);
        color: var(--text);
      }
      .modal-avatar {
        width: 160px;
        height: 160px;
        border-radius: 12px;
        object-fit: cover;
        background: rgba(255, 255, 255, 0.02);
      }
    </style>
  </head>

  <body>
    <div class="app">
      <aside class="sidebar" role="navigation" aria-label="Main navigation">
        <div class="sidebar-inner">
          <h1 class="logo">GyanSetu</h1>
          <nav>
            <ul class="menu">
              <li class="menu-item" data-page="home">
                <i class="fas fa-house"></i><span>Home</span>
              </li>
              <li class="menu-item" data-page="lessons">
                <i class="fas fa-book-open"></i><span>Lessons</span>
              </li>
              <li class="menu-item" data-page="games">
                <i class="fas fa-gamepad"></i><span>Games</span>
              </li>
              <li class="menu-item" data-page="progress">
                <i class="fas fa-chart-simple"></i><span>Progress</span>
              </li>
              <li class="menu-item" data-page="rewards">
                <i class="fas fa-award"></i><span>Rewards</span>
              </li>
              <li class="menu-item active" data-page="settings">
                <i class="fas fa-gear"></i><span>Settings</span>
              </li>
            </ul>
          </nav>
          <div class="sidebar-bottom">
            <button class="login" id="loginBtn" style="background: none">
              <i class="fas fa-right-from-bracket"></i><span>Log Out</span>
            </button>
          </div>
        </div>
      </aside>

      <main class="content">
        <div class="lang-fixed">
          <i class="fas fa-globe"></i>
          <label for="language" class="lang-label">Language:</label>
          <select id="language" class="lang-select input">
            <option value="en">English</option>
            <option value="hi">Hindi</option>
            <option value="or">Odia</option>
          </select>
        </div>

        <section id="settings" class="page active">
          <h2 class="page-title">Settings</h2>

          <div class="settings-grid">
            <!-- Profile, language, grade -->
            <div>
              <div class="setting-card profile-card">
                <div class="profile-card-content" style="display:flex;gap:12px;align-items:center">
                  <div class="profile-info">
                    <img id="profileAvatar" src="../assets/img/1.png" alt="Profile" class="avatar"/>
                    <div class="profile-text">
                      <h3 id="profileName">John Doe</h3>
                      <p class="muted" id="profileEmail">johndoe@email.com</p>
                    </div>
                  </div>
                </div>
                <div>
                  <button class="edit-profile-btn" id="openEditBtn">Edit Profile</button>
                </div>
              </div>

              <div class="setting-card" style="margin-top:16px">
                <h4>Language</h4>
                <div class="dropdown-row" style="margin-top:12px">
                  <select id="cardLanguage" class="input">
                    <option value="en">English</option>
                    <option value="hi">Hindi</option>
                    <option value="or">Odia</option>
                  </select>
                </div>
              </div>

              <div class="setting-card" style="margin-top:12px">
                <h4>Grade</h4>
                <div class="dropdown-row" style="margin-top:12px">
                  <select id="cardGrade" class="input small">
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>

    <!-- EDIT PROFILE MODAL -->
    <div id="editModal" class="modal" role="dialog" aria-hidden="true">
      <div class="modal-card" role="document">
        <div style="display:flex;flex-direction:column;gap:12px;align-items:center">
          <img id="modalAvatar" src="../assets/img/avatar.jpg" alt="avatar preview" class="modal-avatar"/>
          <input type="file" id="modalAvatarFile" accept="image/*" />
          <button class="btn" id="modalUploadAvatar">Preview Image</button>
        </div>
        <div>
          <h3>Edit profile</h3>
          <label class="muted">Name</label>
          <input id="modalName" class="input"/>
          <label class="muted" style="margin-top:8px">Email</label>
          <input id="modalEmail" class="input"/>
          <label class="muted" style="margin-top:8px">Profile text</label>
          <textarea id="modalProfile" rows="3" class="input"></textarea>
          <div style="display:flex;gap:8px;margin-top:8px">
            <div style="flex:1">
              <label class="muted">Grade</label>
              <select id="modalGrade" class="input small">
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
              </select>
            </div>
            <div style="flex:1">
              <label class="muted">Language</label>
              <select id="modalLanguage" class="input">
                <option value="en">English</option>
                <option value="hi">Hindi</option>
                <option value="or">Odia</option>
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn" id="modalCancelBtn">Cancel</button>
            <button class="btn edit-profile-btn" id="modalSaveBtn">Save</button>
            <button class="btn danger" id="modalDeleteBtn">Delete Profile</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings DB wrapper -->
    <script src="../js/settings-db.js"></script>

    <!-- Integration script -->
    <script>
      (function(){
        const profileAvatar = document.getElementById("profileAvatar");
        const profileName = document.getElementById("profileName");
        const profileEmail = document.getElementById("profileEmail");
        const cardLanguage = document.getElementById("cardLanguage");
        const cardGrade = document.getElementById("cardGrade");
        const openEditBtn = document.getElementById("openEditBtn");
        const editModal = document.getElementById("editModal");
        const modalName = document.getElementById("modalName");
        const modalEmail = document.getElementById("modalEmail");
        const modalProfile = document.getElementById("modalProfile");
        const modalGrade = document.getElementById("modalGrade");
        const modalLanguage = document.getElementById("modalLanguage");
        const modalAvatar = document.getElementById("modalAvatar");
        const modalCancelBtn = document.getElementById("modalCancelBtn");
        const modalSaveBtn = document.getElementById("modalSaveBtn");
        const modalDeleteBtn = document.getElementById("modalDeleteBtn");

        const DEFAULT_EMAIL = "johndoe@email.com";
        const DEFAULT_SETTINGS = {
          email: DEFAULT_EMAIL,
          name: "John Doe",
          language: "en",
          grade: "8",
          profile: "Learner",
          avatar: "../assets/img/avatar.jpg",
          badges: [],
          xp: 0,
        };

        let currentSettings = null;

        // normalize helper
        function normalizeLanguage(lang){
          if(!lang) return "en";
          const l = String(lang).toLowerCase();
          if(l==="en"||l==="english") return "en";
          if(l==="hi"||l==="hindi") return "hi";
          if(l==="or"||l==="odia"||l==="oriya") return "or";
          return "en";
        }

        async function loadSettings(email){
          const key = (email && email.trim()) || DEFAULT_EMAIL;
          try {
            const s = await SettingsDB.getSettings(key);
            const logged = JSON.parse(localStorage.getItem("gyan_current_user")||"{}");
            const merged = Object.assign({}, DEFAULT_SETTINGS, s||{}, logged||{});
            merged.language = normalizeLanguage(merged.language);
            currentSettings = merged;

            profileName.textContent = merged.name || "Unknown";
            profileEmail.textContent = merged.email || "";
            profileAvatar.src = merged.avatar || "../assets/img/avatar.jpg";
            cardLanguage.value = merged.language;
            cardGrade.value = merged.grade || "8";

            const topLang = document.getElementById("language");
            if(topLang) topLang.value = merged.language;
          } catch(e){
            console.error("loadSettings err", e);
          }
        }

        window.addEventListener("DOMContentLoaded", async()=>{
          await SettingsDB.openDB();
          const raw = localStorage.getItem("gyan_current_user");
          let email = DEFAULT_EMAIL;
          if(raw){
            try{ email = JSON.parse(raw).email || DEFAULT_EMAIL; }catch{}
          }
          await loadSettings(email);
        });

        openEditBtn.addEventListener("click", ()=>{
          if(!currentSettings) return;
          modalName.value = currentSettings.name || "";
          modalEmail.value = currentSettings.email || "";
          modalProfile.value = currentSettings.profile || "";
          modalGrade.value = currentSettings.grade || "8";
          modalLanguage.value = currentSettings.language || "en";
          modalAvatar.src = currentSettings.avatar || "../assets/img/avatar.jpg";
          editModal.classList.add("show");
        });

        modalCancelBtn.addEventListener("click", ()=>{
          editModal.classList.remove("show");
        });

        modalSaveBtn.addEventListener("click", async()=>{
          const newEmail = (modalEmail.value||"").trim();
          if(!newEmail) return alert("Email is required");
          const updated = Object.assign({}, currentSettings, {
            email: newEmail,
            name: modalName.value||"Unknown",
            profile: modalProfile.value||"",
            grade: modalGrade.value||"8",
            language: normalizeLanguage(modalLanguage.value),
            avatar: modalAvatar.src || "../assets/img/avatar.jpg"
          });
          await SettingsDB.saveSettings(updated);
          localStorage.setItem("gyan_current_user", JSON.stringify(updated));
          await loadSettings(newEmail);
          editModal.classList.remove("show");
          alert("Profile saved");
        });

        modalDeleteBtn.addEventListener("click", async()=>{
          if(!currentSettings||!currentSettings.email) return;
          const req = indexedDB.open("gyansetu-settings");
          req.onsuccess = function(e){
            const db = e.target.result;
            const tx = db.transaction("settings","readwrite");
            tx.objectStore("settings").delete(currentSettings.email);
            tx.oncomplete = ()=>{
              localStorage.removeItem("gyan_current_user");
              loadSettings(DEFAULT_EMAIL);
              editModal.classList.remove("show");
              alert("Profile deleted");
            };
          }
        });
      })();
    </script>

    <script src="../main.js"></script>
    <script src="../js/nav.js"></script>
    <script src="../js/script.js"></script>
  </body>
</html>
