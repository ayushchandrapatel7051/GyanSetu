<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>GyanSetu â€” Settings</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="../css/style.css" />

    <style>
      /* minimal helpers (rest is in style.css) */
      .settings-grid {
        display: grid;
        grid-template-columns: 1fr 320px;
        gap: 18px;
        align-items: start;
      }
      .setting-card {
        background: var(--card);
        padding: 18px;
        border-radius: 12px;
        box-shadow: var(--shadow);
      }
      .profile-card {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }
      .profile-info {
        display: flex;
        gap: 12px;
        align-items: center;
      }
      .avatar {
        width: 64px;
        height: 64px;
        object-fit: cover;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.03);
      }
      .muted {
        color: var(--muted);
      }
      .btn {
        padding: 8px 12px;
        border-radius: 8px;
        cursor: pointer;
      }
      .small {
        width: 120px;
      }
      .badges-list {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 8px;
      }
      .badge-chip {
        padding: 6px 8px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.03);
      }
      input.input,
      select.input,
      textarea.input {
        width: 100%;
        padding: 8px;
        border-radius: 8px;
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.04);
        color: var(--text);
      }
      .modal-avatar {
        width: 160px;
        height: 160px;
        border-radius: 12px;
        object-fit: cover;
        background: rgba(255, 255, 255, 0.02);
      }
    </style>
  </head>

  <body>
    <div class="app">
      <aside class="sidebar" role="navigation" aria-label="Main navigation">
        <div class="sidebar-inner">
          <h1 class="logo">GyanSetu</h1>
          <nav>
            <ul class="menu">
              <li class="menu-item" data-page="home">
                <i class="fas fa-house"></i><span>Home</span>
              </li>
              <li class="menu-item" data-page="lessons">
                <i class="fas fa-book-open"></i><span>Lessons</span>
              </li>
              <li class="menu-item" data-page="games">
                <i class="fas fa-gamepad"></i><span>Games</span>
              </li>
              <li class="menu-item" data-page="progress">
                <i class="fas fa-chart-simple"></i><span>Progress</span>
              </li>
              <li class="menu-item" data-page="rewards">
                <i class="fas fa-award"></i><span>Rewards</span>
              </li>
              <li class="menu-item active" data-page="settings">
                <i class="fas fa-gear"></i><span>Settings</span>
              </li>
            </ul>
          </nav>
          <div class="sidebar-bottom">
            <button class="login" id="loginBtn" style="background: none">
              <i class="fas fa-right-from-bracket"></i><span>Log Out</span>
            </button>
          </div>
        </div>
      </aside>

      <main class="content">
        <div class="lang-fixed">
          <i class="fas fa-globe"></i>
          <label for="language" class="lang-label">Language:</label>
          <select id="language" class="lang-select input">
            <option value="en">English</option>
            <option value="hi">Hindi</option>
            <option value="or">Odia</option>
          </select>
        </div>

        <section id="settings" class="page active">
          <h2 class="page-title">Settings</h2>

          <div class="settings-grid">
            <!-- Profile, language, grade, badges & xp -->
            <div>
              <div class="setting-card profile-card">
                <div
                  class="profile-card-content"
                  style="display: flex; gap: 12px; align-items: center"
                >
                  <div class="profile-info">
                    <img
                      id="profileAvatar"
                      src="../assets/avatar.jpg"
                      alt="Profile"
                      class="avatar"
                    />
                    <div class="profile-text">
                      <h3 id="profileName">John Doe</h3>
                      <p class="muted" id="profileEmail">johndoe@email.com</p>
                    </div>
                  </div>
                </div>
                <div>
                  <button class="edit-profile-btn" id="openEditBtn">
                    Edit Profile
                  </button>
                </div>
              </div>

              <div class="setting-card" style="margin-top: 16px">
                <h4>Language</h4>
                <div class="dropdown-row" style="margin-top: 12px">
                  <select id="cardLanguage" class="input">
                    <option value="en">English</option>
                    <option value="hi">Hindi</option>
                    <option value="or">Odia</option>
                  </select>
                </div>
              </div>

              <div class="setting-card" style="margin-top: 12px">
                <h4>Grade</h4>
                <div class="dropdown-row" style="margin-top: 12px">
                  <select id="cardGrade" class="input small">
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Right column -->
            <div style="display: none">
              <div class="setting-card">
                <h4>Quick Actions</h4>
                <div style="display: flex; flex-direction: column; gap: 8px">
                  <button class="btn" id="exportBtn">
                    Export Current Profile (JSON)
                  </button>
                  <button class="btn" id="listProfilesBtn">
                    List Saved Profiles
                  </button>
                </div>
              </div>

              <div class="setting-card" style="margin-top: 12px">
                <h4>Info</h4>
                <div class="muted" style="font-size: 0.95rem">
                  Click Edit Profile to open the popup and change name, email,
                  grade, language, avatar and profile text.
                </div>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>

    <!-- EDIT PROFILE MODAL -->
    <div id="editModal" class="modal" role="dialog" aria-hidden="true">
      <div class="modal-card" role="document">
        <div
          style="
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: center;
          "
        >
          <img
            id="modalAvatar"
            src="../assets/avatar.jpg"
            alt="avatar preview"
            class="modal-avatar"
          />
          <input type="file" id="modalAvatarFile" accept="image/*" />
          <button class="btn" id="modalUploadAvatar">Preview Image</button>
        </div>

        <div>
          <h3>Edit profile</h3>

          <label class="muted">Name</label>
          <input id="modalName" class="input" />

          <label class="muted" style="margin-top: 8px">Email</label>
          <input id="modalEmail" class="input" />

          <label class="muted" style="margin-top: 8px">Profile text</label>
          <textarea id="modalProfile" rows="3" class="input"></textarea>

          <div style="display: flex; gap: 8px; margin-top: 8px">
            <div style="flex: 1">
              <label class="muted">Grade</label>
              <select id="modalGrade" class="input small">
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
              </select>
            </div>
            <div style="flex: 1">
              <label class="muted">Language</label>
              <select id="modalLanguage" class="input">
                <option value="en">English</option>
                <option value="hi">Hindi</option>
                <option value="or">Odia</option>
              </select>
            </div>
          </div>

          <div class="modal-footer">
            <button class="btn" id="modalCancelBtn">Cancel</button>
            <button class="btn edit-profile-btn" id="modalSaveBtn">Save</button>
            <button class="btn danger" id="modalDeleteBtn">
              Delete Profile
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings DB wrapper -->
    <script src="../js/settings-db.js"></script>

    <!-- Integration script -->
    <script>
      (function () {
        const profileAvatar = document.getElementById("profileAvatar");
        const profileName = document.getElementById("profileName");
        const profileEmail = document.getElementById("profileEmail");

        const cardLanguage = document.getElementById("cardLanguage");
        const cardGrade = document.getElementById("cardGrade");
        const badgesList = document.getElementById("badgesList");
        const newBadgeInput = document.getElementById("newBadgeInput");
        const addBadgeBtn = document.getElementById("addBadgeBtn");
        const xpValue = document.getElementById("xpValue");
        const xpInput = document.getElementById("xpInput");
        const setXpBtn = document.getElementById("setXpBtn");

        const exportBtn = document.getElementById("exportBtn");
        const listProfilesBtn = document.getElementById("listProfilesBtn");

        // modal refs
        const editModal = document.getElementById("editModal");
        const openEditBtn = document.getElementById("openEditBtn");
        const modalName = document.getElementById("modalName");
        const modalEmail = document.getElementById("modalEmail");
        const modalProfile = document.getElementById("modalProfile");
        const modalGrade = document.getElementById("modalGrade");
        const modalLanguage = document.getElementById("modalLanguage");
        const modalAvatar = document.getElementById("modalAvatar");
        const modalAvatarFile = document.getElementById("modalAvatarFile");
        const modalUploadAvatar = document.getElementById("modalUploadAvatar");
        const modalCancelBtn = document.getElementById("modalCancelBtn");
        const modalSaveBtn = document.getElementById("modalSaveBtn");
        const modalDeleteBtn = document.getElementById("modalDeleteBtn");

        const DEFAULT_EMAIL = "johndoe@email.com";
        const DEFAULT_SETTINGS = {
          email: DEFAULT_EMAIL,
          name: "John Doe",
          language: "en",
          grade: "8",
          profile: "Learner",
          avatar: "../assets/avatar.jpg",
          badges: ["starter"],
          xp: 100,
        };

        let currentSettings = null;

        // render into page
        function renderSettings(s) {
          const settings = s || DEFAULT_SETTINGS;
          currentSettings = settings;

          profileName.textContent = settings.name || "Unknown";
          profileEmail.textContent = settings.email || "";
          cardLanguage.value = settings.language || "en";
          cardGrade.value = settings.grade || "8";
          xpValue.textContent = settings.xp != null ? settings.xp : 0;

          profileAvatar.src = settings.avatar || "../assets/avatar.jpg";

          badgesList.innerHTML = "";
          (settings.badges || []).forEach((b) => {
            const el = document.createElement("div");
            el.className = "badge-chip";
            el.textContent = b;
            el.title = "Click to remove";
            el.style.cursor = "pointer";
            el.addEventListener("click", async () => {
              currentSettings.badges = (currentSettings.badges || []).filter(
                (x) => x !== b
              );
              await SettingsDB.saveSettings(currentSettings);
              renderSettings(currentSettings);
            });
            badgesList.appendChild(el);
          });

          const topLang = document.getElementById("language");
          if (topLang) topLang.value = settings.language || "en";
        }

        function readFileAsDataURL(file) {
          return new Promise((resolve, reject) => {
            const fr = new FileReader();
            fr.onload = () => resolve(fr.result);
            fr.onerror = (e) => reject(e);
            fr.readAsDataURL(file);
          });
        }

        async function loadSettings(email) {
          const key = (email && email.trim()) || DEFAULT_EMAIL;
          try {
            const s = await SettingsDB.getSettings(key);
            if (s) {
              renderSettings(s);
            } else {
              // try to take name from logged-in user
              let defaultName = "Unknown";
              try {
                if (window.currentUser && window.currentUser.name) {
                  defaultName = window.currentUser.name;
                } else {
                  const raw = localStorage.getItem("gyan_current_user");
                  if (raw) {
                    const parsed = JSON.parse(raw);
                    if (parsed.name) defaultName = parsed.name;
                  }
                }
              } catch (e) {
                console.warn("Could not get name from login info", e);
              }

              const init = Object.assign({}, DEFAULT_SETTINGS, {
                email: key,
                name: defaultName,
              });
              await SettingsDB.saveSettings(init);
              renderSettings(init);
            }
          } catch (e) {
            console.error("loadSettings err", e);
            renderSettings(DEFAULT_SETTINGS);
          }
        }

        // --- INIT ---
        window.addEventListener("DOMContentLoaded", async () => {
          try {
            await SettingsDB.openDB();
          } catch (e) {
            console.warn("SettingsDB open failed", e);
          }

          let email = null;
          if (window.currentUser && window.currentUser.email) {
            email = window.currentUser.email;
          } else {
            try {
              const raw = localStorage.getItem("gyan_current_user");
              if (raw) {
                const parsed = JSON.parse(raw);
                email = parsed.email;
              }
            } catch (e) {
              console.warn("localStorage parse failed", e);
            }
          }
          if (!email) email = DEFAULT_EMAIL;
          await loadSettings(email);
        });

        // modal open
        openEditBtn.addEventListener("click", () => {
          if (!currentSettings) return;
          modalName.value = currentSettings.name || "";
          modalEmail.value = currentSettings.email || "";
          modalProfile.value = currentSettings.profile || "";
          modalGrade.value = currentSettings.grade || "8";
          modalLanguage.value = currentSettings.language || "en";
          modalAvatar.src = currentSettings.avatar || "../assets/avatar.jpg";
          editModal.classList.add("show");
          editModal.setAttribute("aria-hidden", "false");
        });

        modalCancelBtn.addEventListener("click", () => {
          editModal.classList.remove("show");
          editModal.setAttribute("aria-hidden", "true");
        });

        modalUploadAvatar.addEventListener("click", async (ev) => {
          ev.preventDefault();
          if (!modalAvatarFile.files || modalAvatarFile.files.length === 0)
            return alert("Choose an image first");
          try {
            const dataUrl = await readFileAsDataURL(modalAvatarFile.files[0]);
            modalAvatar.src = dataUrl;
            alert("Preview updated. Click Save to persist.");
          } catch (e) {
            console.error(e);
            alert("Failed to read image");
          }
        });

        // modal save
        modalSaveBtn.addEventListener("click", async () => {
          const newEmail = (modalEmail.value || "").trim();
          if (!newEmail) return alert("Email is required");
          const updated = {
            email: newEmail,
            name: modalName.value || "Unknown",
            language: modalLanguage.value || "en",
            grade: modalGrade.value || "8",
            profile: modalProfile.value || "",
            avatar:
              modalAvatar.src ||
              (currentSettings && currentSettings.avatar) ||
              "../assets/avatar.jpg",
            badges:
              currentSettings && currentSettings.badges
                ? currentSettings.badges.slice()
                : [],
            xp:
              currentSettings && currentSettings.xp != null
                ? currentSettings.xp
                : 0,
          };

          try {
            await SettingsDB.saveSettings(updated);
            localStorage.setItem(
              "gyan_current_user",
              JSON.stringify({ email: newEmail, name: updated.name })
            ); // update login cache
            await loadSettings(newEmail);
            editModal.classList.remove("show");
            alert("Profile saved");
          } catch (e) {
            console.error(e);
            alert("Save failed: " + (e && e.message ? e.message : e));
          }
        });

        // modal delete
        modalDeleteBtn.addEventListener("click", async () => {
          if (!currentSettings || !currentSettings.email)
            return alert("No profile loaded");
          if (
            !confirm(
              "Delete stored settings for " + currentSettings.email + " ?"
            )
          )
            return;
          try {
            const req = indexedDB.open("gyansetu-settings");
            req.onsuccess = function (e) {
              const db = e.target.result;
              const tx = db.transaction("settings", "readwrite");
              tx.objectStore("settings").delete(currentSettings.email);
              tx.oncomplete = function () {
                localStorage.removeItem("gyan_current_user");
                loadSettings(DEFAULT_EMAIL);
                editModal.classList.remove("show");
                alert("Profile deleted");
              };
            };
          } catch (e) {
            console.error(e);
            alert("Delete failed");
          }
        });

        // badges
        addBadgeBtn.addEventListener("click", async () => {
          const b = (newBadgeInput.value || "").trim();
          if (!b) return;
          currentSettings.badges = currentSettings.badges || [];
          if (!currentSettings.badges.includes(b)) {
            currentSettings.badges.push(b);
            await SettingsDB.saveSettings(currentSettings);
            newBadgeInput.value = "";
            renderSettings(currentSettings);
          }
        });

        // XP set
        setXpBtn.addEventListener("click", async () => {
          const n = Number(xpInput.value || 0);
          if (isNaN(n) || n < 0) return alert("Enter valid XP");
          currentSettings.xp = n;
          await SettingsDB.saveSettings(currentSettings);
          renderSettings(currentSettings);
        });

        // Quick actions
        exportBtn.addEventListener("click", () => {
          if (!currentSettings) return alert("No profile loaded");
          const data = JSON.stringify(currentSettings, null, 2);
          const blob = new Blob([data], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = (currentSettings.email || "profile") + ".json";
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        });

        listProfilesBtn.addEventListener("click", async () => {
          const all = await SettingsDB.getAllSettings();
          alert(
            "Saved profiles:\n" +
              all
                .map((p) => p.email + " (" + (p.name || "Unknown") + ")")
                .join("\n")
          );
        });
      })();
    </script>

    <script src="../main.js"></script>
    <script src="../js/nav.js"></script>
    <script src="../js/script.js"></script>
  </body>
</html>
